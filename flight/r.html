---
title: "spotify"
author: "Sean Chang"
date: "March 7, 2016"
output: html_document
---

The goal of this assignment is to demonstrate your ability 
to derive meaningful insights from a real?world data set, 
to communicate and contextualize findings, and, most importantly, 
to showcase your creativity and analytical rigor in generating and testing hypotheses. 
http://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236&DB_Short_Name=On-Time

The assignment is intentionally unspecific and exploratory in nature; your task is to formulate a clear research framework, questions, and findings.The data set at hand covers passenger airline travel within the United States from 1987 to the present and can be accessed here. We've also attached additiona data on carriers and airport locations. We encourage you to merge the air traffic data
with other data sets to contextualize your investigation. Mindful of the time we are giving you to complete this assignment, we recommend somewhat narrowly focusing your investigation.

We're looking for a few page document that summarizes your investigation and
your findings.

Q1: can we predict the arrival time based on...
Q2: predict the cancellation rate?


```{r}
#dat <- read.csv("~/Documents/topairports2.csv")
#dat <- read.csv("~/Dropbox/codes/2016_spotify/sample_dat_w_timestamp.csv")
#setwd('/Users/pingpong3mike/Dropbox/codes/2016_spotify')
setwd('/home/sc268/Dropbox/codes/2016_spotify')
getwd()

dat <- read.csv('sample_w_weather_origin_dest.csv')
dat$CRSDepTimestamp = strptime(dat$CRSDepTimestamp,'%Y-%m-%d %H:%M:%S') 
class(dat$CRSDepTimestamp)
dat$CRSDepTimeHour = as.numeric(format(dat$CRSDepTimestamp, format='%H'))
#save results
errors <- data.frame(error = double(), type = character(), method = character(),stringsAsFactors=FALSE)



```


Modelling

```{r}
RMSE <- function(pred, true){res = sqrt(mean((pred - true)^2, na.rm = TRUE));          print (res);return (res);}
MSE <- function(pred, true){res = mean((pred - true)^2, na.rm = TRUE);
        print (res); return (res);}
MAE <- function(pred, true){res = mean(abs(pred - true), na.rm = TRUE);
        print (res); return (res);}
```

```{r}
#linear regression 
dat <- read.csv('sample_w_weather_origin_dest.csv')
dat$UniqueCarrier = as.character(dat$UniqueCarrier)


dat.train <- dat[1:round(nrow(dat)*0.9), ];  
rownames(dat.train) <- 1:nrow(dat.train)
dat.test <- dat[round(nrow(dat)*0.9): nrow(dat), ]
rownames(dat.test) <- 1:nrow(dat.test)

#random sampling
train_rows <- sample(nrow(dat), round(nrow(dat) * 0.9))
dat.train <- dat[train_rows, ];  
rownames(dat.train) <- 1:nrow(dat.train)
dat.test <- dat[-train_rows, ]
rownames(dat.test) <- 1:nrow(dat.test)

#only select UniqueCarrier appeared before in the training dataset
dat.test = dat.test[dat.test$UniqueCarrier %in% 

#
#id <- which(!(dat.test$UniqueCarrier %in% levels(dat.train$UniqueCarrier)))

#dat.test$UniqueCarrier = as.factor(dat.test$UniqueCarrier)
#dat.train$UniqueCarrier = as.factor(dat.train$UniqueCarrier)

#modelling 
model_lr <- lm( ArrDelay ~ Origin + Dest + UniqueCarrier ,
                     #  origin_tmpf + origin_dwpf+ origin_relh+ origin_sknt + origin_p01i + origin_alti + origin_vsby +   
                           #     dest_tmpf + dest_dwpf + dest_relh  ,  
                          #     dest_sknt + dest_p01i + dest_alti + dest_vsby, 
                  data =  dat.train);

summary(model_lr)
res <- predict(model_lr, dat.test)
mae <- MAE(res, dat.test$ArrDelay);
rmse <- RMSE(res, dat.test$ArrDelay);

errors[nrow(errors)+1,] <- c(mae, 'MAE', 'Linear regression')
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'Linear regression')

```

```{r}
# ridge reg
library(glmnet)
fit <- glmnet(, y, family="gaussian", alpha=0, lambda=0.001)

```


```{r}
#random forest full
library(randomForest)
dat <- read.csv('sample_w_weather_origin_dest.csv')

#random sampling
train_rows <- sample(nrow(dat), round(nrow(dat) * 0.9))
dat.train <- dat[train_rows, ];  
rownames(dat.train) <- 1:nrow(dat.train)
dat.test <- dat[-train_rows, ]
rownames(dat.test) <- 1:nrow(dat.test)


num_tree <- 10; #num of trees
model_RF <- randomForest( ArrDelay ~ Origin + Dest + UniqueCarrier + FlightNum +#  CRSDepTimeHour,
                               origin_tmpf + origin_dwpf+ origin_relh+ origin_sknt + origin_p01i + origin_alti + origin_vsby + 
                                 dest_tmpf +   dest_dwpf +  dest_relh +  dest_sknt + dest_p01i + dest_alti + dest_vsby, 
                            ntree=num_tree ,
        na.action = na.omit, type = "regression", importance = TRUE, data =  dat.train)
  
tmp = importance(model_RF, type=1)

res <- predict(model_RF, dat.test, predict.all=FALSE);
mae <- MAE(res, dat.test$ArrDelay); 
rmse <- RMSE(res, dat.test$ArrDelay);

errors[nrow(errors)+1,] <- c(mae, 'MAE', 'Random Forest');
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'Random Forest');
```










```{r}
###  without destination weather
model_RF_wo_dest <- randomForest( ArrDelay ~ Origin + Dest + UniqueCarrier + 
                               origin_tmpf + origin_dwpf+ origin_relh+ origin_sknt + origin_p01i + origin_alti + origin_vsby ,
                                # dest_tmpf +   dest_dwpf +  dest_relh +  dest_sknt + dest_p01i + dest_alti + dest_vsby, 
                            ntree=num_tree ,
        na.action = na.omit, type = "regression", data =  dat.train)


res_wo_dest <- predict(model_RF_wo_dest, dat.test, predict.all=FALSE)
mae <- MAE(res_wo_dest, dat.test$ArrDelay)
rmse <- RMSE(res_wo_dest, dat.test$ArrDelay)
errors[nrow(errors)+1,] <- c(mae, 'MAE', 'RF w.o. Destination weather')
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'RF w.o. Destination weather')


###  without weather
model_RF_wo_weather <- randomForest( ArrDelay ~ Origin + Dest + UniqueCarrier,
                               #origin_tmpf + origin_dwpf+ origin_relh+ origin_sknt + origin_p01i + origin_alti + origin_vsby ,
                                # dest_tmpf +   dest_dwpf +  dest_relh +  dest_sknt + dest_p01i + dest_alti + dest_vsby, 
                            ntree=num_tree ,
        na.action = na.omit, type = "regression", data =  dat.train)


res_wo_weather <- predict(model_RF_wo_dest, dat.test, predict.all=FALSE)
mae <- MAE(res_wo_weather, dat.test$ArrDelay)
rmse <- RMSE(res_wo_weather, dat.test$ArrDelay)
errors[nrow(errors)+1,] <- c(mae, 'MAE', 'RF w.o. weather')
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'RF w.o. weather')




#residual plot
library(ggplot2)
dat.test$pred = res
dat.test$pred_wo_dest = res_wo_dest
ggplot(dat.test, aes(x=ArrDelay, y=pred)) +geom_point(color='dark blue')+ xlab('Arrival Delay') +ylab("Predct Delay")+ggtitle('Prediction v.s. True Arrival Delay') + geom_abline(intercept = 0, slope =1)

ggplot(dat.test, aes(x=ArrDelay, y=pred)) +geom_point(color='dark blue')+ geom_point( aes(x=ArrDelay, y=pred_wo_dest), color='green') + xlab('Arrival Delay') +ylab("Predct Delay")+ggtitle('Prediction v.s. True Arrival Delay')+ geom_abline(intercept = 0, slope =1)

```


```{r}
#collect all models and plot
errors <- data.frame(error = double(), type = character(), method = character(),stringsAsFactors=FALSE)

res <- predict(model_lr, dat.test)
mae <- MAE(res, dat.test$ArrDelay);
rmse <- RMSE(res, dat.test$ArrDelay);
errors[nrow(errors)+1,] <- c(mae, 'MAE', 'Linear regression')
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'Linear regression')

res <- predict(model_RF_wo_weather, dat.test, predict.all=FALSE);
mae <- MAE(res, dat.test$ArrDelay); 
rmse <- RMSE(res, dat.test$ArrDelay);
errors[nrow(errors)+1,] <- c(mae, 'MAE', 'RF');
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'RF');

res <- predict(model_RF_wo_dest, dat.test, predict.all=FALSE);
mae <- MAE(res, dat.test$ArrDelay); 
rmse <- RMSE(res, dat.test$ArrDelay);
errors[nrow(errors)+1,] <- c(mae, 'MAE', 'RF + departure weather');
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'RF + departure weather');


res <- predict(model_RF, dat.test, predict.all=FALSE);
mae <- MAE(res, dat.test$ArrDelay); 
rmse <- RMSE(res, dat.test$ArrDelay);
errors[nrow(errors)+1,] <- c(mae, 'MAE', 'RF + full weather');
errors[nrow(errors)+1,] <- c(rmse, 'RMSE', 'RF + full weather');

#plot errors 
library(ggplot2)
ggplot(errors, aes(x=method, y=as.numeric(error), fill=type))+ geom_bar(stat="identity",position=position_dodge())+  ylab('accuracy') +ggtitle('Features and accuracy')
```

  
```{r}
#XGB
dat <- read.csv('sample_w_weather_origin_dest.csv')

#random sampling
train_rows <- sample(nrow(dat), round(nrow(dat) * 0.9))
dat.train <- dat[train_rows, ];  
rownames(dat.train) <- 1:nrow(dat.train)
dat.test <- dat[-train_rows, ]
rownames(dat.test) <- 1:nrow(dat.test)

colnames(dat)
library(xgboost)
# default: use features
feature.names <- c(  "DayOfWeek"  ,     #"FlightDate"  ,
                     "UniqueCarrier",  
#  "TailNum"         "FlightNum"       "Origin"          "Dest"           
#  "DepDelay"        "CRSArrTime"      "ArrTime"         "ArrDelay"       
 "origin_valid" ,   "origin_tmpf" ,    "origin_dwpf"  ,   "origin_relh",    
 "origin_sknt"  ,   "origin_p01i" ,    "origin_alti"  ,   "origin_vsby" ,   
 "dest_valid"   ,   "dest_tmpf"   ,    "dest_dwpf"    ,   "dest_relh"  ,  
 "dest_sknt"    ,   "dest_p01i"   ,    "dest_alti"    ,   "dest_vsby"  )
# use default features + signupdate
#feature.names <- names(dat.train)[c(2,4:(ncol(dat.train)))]; feature.names


dtrain <- xgb.DMatrix(data.matrix(sapply(dat.train[,feature.names], as.numeric)), 
                      label = as.numeric(dat.train$CancellationCode),
                      missing = NaN)

dval <-   xgb.DMatrix(data.matrix(sapply(dat.test[,feature.names], as.numeric)), 
                      label = as.numeric(dat.test$response),
                      missing = NaN)
#watchlist <- list(eval = dval) 
watchlist <- list(eval = dval, train = dtrain)
param <- list(  objective           = "binary:logistic", #"reg:linear", 
                booster             = "gblinear",
                eta                 = 0.01,
                max_depth           = 8, 
                subsample           = 0.6,
                colsample_bytree    = 0.6,
                eval_metric         = "logloss" #"rmse"
                # alpha = 0.0001, 
                # lambda = 1
                )
clf <- xgb.train(   params              = param, 
                    data                = dtrain, 
                    nrounds             = 5000, # changed from 300
                    verbose             = 2, 
                    #early.stop.round    = 10,
                    watchlist           = watchlist,
                    maximize            = TRUE)

#res          <- predict(clf, data.matrix(sapply(dat.test[,feature.names], as.numeric)), missing = NaN)
res          <- predict(clf, data.matrix(dat.test[,feature.names]), missing = NaN); res

## 
res_official <- predict(clf, data.matrix(sapply(test_dat[,feature.names], as.numeric)), missing = NaN)
test_dat;
df <- data.frame(test_dat$userid, res_official);
res_official
```

cancellation rate
```{r}
dat <- read.csv('sample_w_weather_origin_dest_w_missing.csv')
dat$Cancelled = !dat$CancellationCode ==''

train_rows <- sample(nrow(dat), round(nrow(dat) * 0.9))
dat.train <- dat[train_rows, ];  
rownames(dat.train) <- 1:nrow(dat.train)
dat.test <- dat[-train_rows, ]
rownames(dat.test) <- 1:nrow(dat.test)

library(randomForest)
num_trees = 10
clf <- randomForest( Cancelled ~  Origin + Dest + UniqueCarrier +
                               origin_tmpf + origin_dwpf+ origin_relh+ origin_sknt + origin_p01i + origin_alti + origin_vsby + 
                                 dest_tmpf +   dest_dwpf +  dest_relh +  dest_sknt + dest_p01i + dest_alti + dest_vsby,  
      ntree=num_tree , na.action = na.omit, data =  dat.train)
  



```
















EDA 

```{r}
#gallery
airports <- read.csv("airports.csv")
carriers <- read.csv("carriers.csv", comment.char="#")
dat <- read.csv('sample_w_weather_origin_dest_w_missing.csv')

      
      subcols <- c("Origin")
      res <- count(dat, subcols)
                #join with airport detail table
      res2 <- sqldf("SELECT Origin, freq, airport, state, city, lat, long
                     FROM res
                     JOIN airports 
                     on res.Origin = airports.iata")
      rownames(res2) <- 1:nrow(res2) #reindex
      library(ggmap)
      library(mapproj) 
      ggmap(map)
       TC <- ggmap(map) + geom_point(aes(x = long, y = lat, size = freq), data = res2, alpha = 1)+
                  xlab("longitude") + ylab("latitude")
          


#delay reasons heat map
      #install.packages('gplots')
      library(sqldf)
         
        res2 <- sqldf("SELECT Origin, freq, airport, state, city, lat, long
             FROM res
             JOIN airports 
             on res.Origin = airports.iata")
         
        # top N busiest airports delay reasons  
        res3 <- ddply(dat,~Origin,summarise, CarrierDelay=mean(CarrierDelay, na.rm=TRUE), 
                                     WeatherDelay=mean( WeatherDelay, na.rm=TRUE), 
                                      NASDelay  = mean(NASDelay, na.rm= TRUE), 
                                  SecurityDelay = mean(SecurityDelay, na.rm = TRUE), 
                              LateAircraftDelay = mean(LateAircraftDelay, na.rm= TRUE))  
        res23 <- sqldf("SELECT res2.Origin, freq, airport, state, city, lat, long, 
                                CarrierDelay, WeatherDelay, NASDelay, SecurityDelay, LateAircraftDelay
                         FROM res2
                         JOIN res3 
                         on res2.Origin = res3.Origin")

        library(RColorBrewer); library(gplots)
        row.names(res23) <- res23$airport
        res23_matrix <- data.matrix(res23[,c("CarrierDelay", "WeatherDelay", "NASDelay", "SecurityDelay", "LateAircraftDelay")])
        colnames(res23_matrix) <-c("Carrier", "Weather", "NAS", "Security", "Aircraft")
        # save it
        png("./airports_delay_reasons.png")
           heatmap.2(res23_matrix, Rowv=NA, Colv=NA,  col = brewer.pal(9, "Blues"), scale="column", margins=c(7,14), trace="none",
                     srtCol=25,  adjCol = c(1,1) , key = FALSE )#lmat=rbind( c(0, 3), c(2,1), c(0,4) ), lhei=c(1.5, 4, 2 ) ) 
        dev.off()
```

